<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blog.portal.dao.BlogDao">
    <resultMap id="BlogListMap" type="com.blog.portal.dto.BgmsBlogParam" autoMapping="true">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <collection property="tags" columnPrefix="tag_"
                    ofType="com.blog.portal.dto.BgmsTagParam">
            <id column="id" property="id" jdbcType="BIGINT"/>
            <result column="blog_id" property="blogId" jdbcType="BIGINT"/>
            <result column="name" property="name"/>
        </collection>
    </resultMap>
    <select id="getAllBlogList" resultMap="BlogListMap">
        select
        b.id id,
        b.appreciation ,
        b.commentabled ,
        b.title,
        b.description,
        b.first_picture firstPicture,
        b.content,
        b.create_time createTime,
        b.update_time updateTime,
        b.flag,
        b.flag_url flagUrl,
        b.recommend,
        b.share_statement shareStatement,
        b.state,
        b.ums_id umsId,
        m.nickname,
        m.icon,
        bbs.views,
        bbs.likes,
        t.id tag_id,
        t.blog_id tag_blog_id,
        t.`name` tag_name

        FROM bgms_blog b
        left join bgms_tag t on t.blog_id = b.id
        left join ums_member m on m.id = b.ums_id
        left join bgms_blogstat bbs on bbs.blog_id = b.id
        where b.state = 2
        <if test="id!=null">
            and b.id=#{id}
        </if>
    </select>
    
    <update id="freshBlogViews" parameterType="java.util.List">
        update bgms_blogstat
        set  views=
        <foreach collection="list" item="item" index="index"
                 separator=" " open="case " close=" end">
            when blog_id=#{item.blogId} then #{item.views}
        </foreach>
        where blog_id in
        <foreach collection="list" index="index" item="item"
                 separator="," open="(" close=")">
            #{item.blogId,jdbcType=BIGINT}
        </foreach>
    </update>

    <update id="freshBlogLikes" parameterType="java.util.List">
        update bgms_blogstat
        set  likes=
        <foreach collection="list" item="item" index="index"
                 separator=" " open="case " close=" end">
            when blog_id=#{item.blogId} then #{item.likes}
        </foreach>
        where blog_id in
        <foreach collection="list" index="index" item="item"
                 separator="," open="(" close=")">
            #{item.blogId,jdbcType=BIGINT}
        </foreach>
    </update>

    <update id="freshBlogUmsLikes" parameterType="java.util.List">
        update bgms_blog_likes
        set  ums_ids=
        <foreach collection="list" item="item" index="index"
                 separator=" " open="case " close=" end">
            when blog_id=#{item.blogId} then #{item.umsIds}
        </foreach>, update_time = now()
        where blog_id in
        <foreach collection="list" index="index" item="item"
                 separator="," open="(" close=")">
            #{item.blogId,jdbcType=BIGINT}
        </foreach>
    </update>


    <select id="selectByUmsId" resultMap="BlogListMap">
        select
        b.id id,
        b.title,
        b.description,
        b.content,
        b.create_time createTime,
        b.update_time updateTime,
        b.flag,
        b.flag_url flagUrl,
        b.state,
        b.ums_id umsId,
        m.nickname,
        m.icon,
        bbs.views,
        bbs.likes,
        t.id tag_id,
        t.blog_id tag_blog_id,
        t.`name` tag_name

        FROM bgms_blog b
        left join bgms_tag t on t.blog_id = b.id
        left join ums_member m on m.id = b.ums_id
        left join bgms_blogstat bbs on bbs.blog_id = b.id
        where  b.ums_id=#{userId} and b.state = 2
    </select>

    <select id="selectByCurLogId" resultMap="BlogListMap">
        select
        b.id id,
        b.title,
        b.description,
        b.content,
        b.create_time createTime,
        b.update_time updateTime,
        b.flag,
        b.flag_url flagUrl,
        b.state,
        b.ums_id umsId,
        m.nickname,
        m.icon,
        bbs.views,
        bbs.likes,
        t.id tag_id,
        t.blog_id tag_blog_id,
        t.`name` tag_name

        FROM bgms_blog b
        left join bgms_tag t on t.blog_id = b.id
        left join ums_member m on m.id = b.ums_id
        left join bgms_blogstat bbs on bbs.blog_id = b.id
        where  b.ums_id=#{userId} and b.state != 4
    </select>
</mapper>